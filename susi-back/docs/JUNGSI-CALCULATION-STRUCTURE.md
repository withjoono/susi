# 정시 환산점수식 구조 문서

## 1. 데이터 파일 구조

### 1.1 필요한 JSON 파일 (3개)

```
src/modules/jungsi/calculation/data/
├── 점수표-25-정시-1210-점수표.json    # 과목별 표준점수 → 대학별 환산점수 매핑
├── 2509조건-2024-10-21.json           # 학교별 환산 조건 (환산식코드, 필수과목 등)
└── 2025정시유불리.json                 # 표점합별 대학별 동점수 평균 환산점수
```

---

## 2. 점수표 구조 (점수표-*.json)

### 2.1 기본 구조

```json
{
  "과목명": {
    "표준점수": {
      "백분위": 값,
      "등급": 값,
      "누적(%)": 값,
      "학교코드1": 환산점수,
      "학교코드2": 환산점수,
      ...
    }
  }
}
```

### 2.2 과목 목록 (32개)

| 구분 | 과목명 |
|------|--------|
| 국어 | `국어` |
| 수학 | `수학(미적)`, `수학(기하)`, `수학(확통)` |
| 영어 | `영어` |
| 한국사 | `한국사` |
| 과탐 | `물리학 Ⅰ`, `화학 Ⅰ`, `생명과학 Ⅰ`, `지구과학 Ⅰ`, `물리학 Ⅱ`, `화학 Ⅱ`, `생명과학 Ⅱ`, `지구과학 Ⅱ` |
| 사탐 | `생활과 윤리`, `윤리와 사상`, `한국지리`, `세계지리`, `동아시아사`, `세계사`, `경제`, `정치와 법`, `사회·문화` |
| 제2외국어 | `독일어 Ⅰ`, `프랑스어 Ⅰ`, `스페인어 Ⅰ`, `중국어 Ⅰ`, `일본어 Ⅰ`, `러시아어 Ⅰ`, `아랍어 Ⅰ`, `베트남어 Ⅰ`, `한문 Ⅰ` |

### 2.3 예시

```json
{
  "국어": {
    "130": {
      "백분위": 95,
      "등급": 2,
      "누적(%)": 4.12,
      "가천의학": 127.5,
      "연세자연": 195.0,
      "서울통합": 130.0,
      ...
    },
    "131": { ... },
    ...
  },
  "수학(미적)": {
    "135": {
      "가천의학": 140.0,
      ...
    }
  }
}
```

---

## 3. 학교조건 구조 (조건-*.json)

### 3.1 기본 구조

```json
{
  "학교코드": {
    "필수과목": {
      "미적기하": boolean,  // 미적분/기하 필수 여부
      "확통": boolean,      // 확률과통계 필수 여부
      "과탐": boolean,      // 과학탐구 필수 여부
      "사탐": boolean       // 사회탐구 필수 여부
    },
    "환산식코드": number,   // 1~69, 481 등
    "탐구과목수": number,   // 반영할 탐구 과목 수 (1 또는 2)
    "기본점수": number      // 기본 가산점 (대부분 0)
  }
}
```

### 3.2 예시

```json
{
  "가천의학": {
    "필수과목": { "미적기하": true, "확통": false, "과탐": true, "사탐": false },
    "환산식코드": 1,
    "탐구과목수": 2,
    "기본점수": 0
  },
  "서울통합": {
    "필수과목": { "미적기하": false, "확통": false, "과탐": false, "사탐": false },
    "환산식코드": 1,
    "탐구과목수": 2,
    "기본점수": 0
  },
  "경기자전": {
    "필수과목": { "미적기하": false, "확통": false, "과탐": false, "사탐": false },
    "환산식코드": 48,
    "탐구과목수": 1,
    "기본점수": 0
  }
}
```

---

## 4. 유불리 구조 (유불리.json)

### 4.1 기본 구조

```json
{
  "Sheet1": [
    {
      "점수환산": 표점합(국+수+탐2),
      "학교코드1": 동점수평균환산점수,
      "학교코드2": 동점수평균환산점수,
      ...
    }
  ]
}
```

### 4.2 예시

```json
{
  "Sheet1": [
    {
      "점수환산": 350,
      "가천의학": 8.8,
      "연세자연": 625.35,
      "서울통합": 348.50,
      "고려자연": 571.52,
      ...
    },
    {
      "점수환산": 351,
      ...
    }
  ]
}
```

### 4.3 유불리 계산

```
유불리 = 동점수평균환산점수 - 사용자환산점수

- 음수(-)면: 사용자가 평균보다 높음 → 유리
- 양수(+)면: 사용자가 평균보다 낮음 → 불리
```

---

## 5. 환산점수 계산 흐름

```
총 환산점수 = 수능환산필수 + 수능환산선택 + 수능환산가중택 + 추가가감 + 기본점수
```

### 5.1 계산 단계

1. **점수표에서 환산점수 조회**: 각 과목의 표준점수로 해당 학교의 환산점수 조회
2. **수능환산필수계산기**: 필수로 반영되는 과목들의 환산점수 합산
3. **수능환산선택계산기**: 선택적으로 유리한 조합 계산
4. **수능환산가중택계산기**: 가중치 적용 계산
5. **추가가감계산기**: 특정 조건에 따른 가산/감점
6. **기본점수 추가**: 학교별 기본 가산점

---

## 6. 환산식코드별 상세 계산 방식

### 【코드 1】 기본형 (310개 학교)

**사용 학교**: 가천의학, 연세자연, 고려자연, 서울통합, 한양자연 등 대부분

```
수능환산필수 = 국어환산 + 수학환산 + 영어환산 + 한국사환산 + 탐구환산(2과목)
수능환산선택 = 0
수능환산가중택 = 0
```

---

### 【코드 2】 (3개 학교: 목포인문, 서과문예, 을지사회1)

```
수능환산필수 = 국어환산 + 영어환산 + 한국사환산
수능환산선택 = MAX(수학환산, 탐구환산)
```

---

### 【코드 3, 4】 (2개 학교: 수원인문1, 한남인문)

```
수능환산필수 = 국어환산 + 한국사환산

코드 3: 수능환산선택 = 수영탐 중 (최저×3 + 중간×2.5 + 최고×1.5)
코드 4: 수능환산선택 = 수영탐 중 상위 2과목 합
```

---

### 【코드 5】 (6개 학교: 목포자연, 순천자연 등)

```
수능환산필수 = 수학환산 + 영어환산 + 한국사환산
수능환산선택 = MAX(국어환산, 탐구환산)
```

---

### 【코드 6】 (4개 학교: 목포약학, 상명천자연 등)

```
수능환산필수 = 수학환산 + 탐구환산 + 한국사환산
수능환산선택 = MAX(국어환산, 영어환산)
```

---

### 【코드 7, 8】 (6개 학교)

```
수능환산필수 = 수학환산 + 한국사환산

코드 7: 수능환산선택 = 국영탐 중 (최저×3 + 중간×2.5 + 최고×1.5)
코드 8: 수능환산선택 = 국영탐 중 상위 2과목 합
```

---

### 【코드 9, 10, 11】 (20개 학교: 가톨릭일반1, 동덕자전 등)

```
수능환산필수 = 영어환산 + 탐구환산 + 한국사환산

코드 9, 10: 수능환산선택 = 국수 중 (최고×3.5 + 최저×2.5)
코드 11: 수능환산선택 = MAX(국어환산, 수학환산)
```

---

### 【코드 12】 (8개 학교: 관동통합, 서울신인문 등)

```
수능환산필수 = 영어환산 + 한국사환산
수능환산선택 = 국수탐 중 상위 2과목 합
```

---

### 【코드 13】 (2개 학교: 중부사범, 중부통합)

```
수능환산필수 = 탐구환산
수능환산선택 = 국수영 중 상위 2과목 합
```

---

### 【코드 14, 15】 (19개 학교)

```
수능환산필수 = 탐구환산 + 한국사환산

코드 14: 수능환산선택 = 국수영 중 상위 2과목 합
코드 15: 수능환산선택 = 국수영 중 최고 1과목
```

---

### 【코드 16】 (14개 학교: 강원삼인문, 건국글인문 등)

```
수능환산필수 = 한국사환산
수능환산선택 = 국수영탐 중 상위 2과목 합
```

---

### 【코드 17, 18】 (23개 학교)

```
수능환산필수 = 한국사환산

코드 17: 수능환산선택 = 국수영탐 중 상위 3과목 합
         추가가감: 과탐2개 + 탐구>3번째 시 → 수학환산 추가

코드 18: 수능환산선택 = 국수영탐 중 상위 3과목 합
```

---

### 【코드 19, 20】 (2개 학교)

```
수능환산필수 = 한국사환산

코드 19: 수능환산선택 = 국수탐 중 상위 2과목 합
코드 20: 수능환산선택 = 국수탐 중 상위 2과목 + MAX(영어, 한국사)
```

---

### 【코드 21~30】 가중택 계산 (각 1~2개 학교)

```
수능환산필수 = 한국사환산
수능환산가중택 = 국수영탐에 가중치 적용

코드 21: (1위×4 + 2위×3.5 + 3위×2.5)
코드 22: (1위×4.5 + 2위×3.5 + 3위×2)
코드 23: (1위×6 + 2위×4)
코드 24: (1위×8 + 2위×2)
코드 25: (1위×3.5 + 2위×3.5 + 3위×2 + 4위×1)
코드 26, 27: (1위×4.5 + 2위×3.5 + 3위×2) + 미적기하 가산
코드 28: (1위×4 + 2위×3 + 3위×2 + 4위×1)
코드 29: (1위×5 + 2위×3 + 3위×2)
코드 30: (1위×8 + 2위×2)
```

---

### 【코드 31~35】 유불리 선택형 (각 1~2개 학교)

두 가지 비율 중 유리한 것 선택:

```
코드 31 (인하융합자연, 인하자전자연):
  MAX(국2.5+수4+영1+탐2.5, 국2.5+수3.5+영1+탐3)

코드 32 (성균글바메, 성균자연):
  MAX(국2+수4+영1+탐3, 국3+수4+영1+탐2)

코드 33 (성균글경영, 성균인문):
  MAX(국3.5+수2.5+영1+탐3, 국3+수4+영1+탐2)

코드 34 (인하융합인문, 인하자전인문):
  MAX(국3.5+수3+영1+탐2.5, 국3+수3+영1+탐3)

코드 35 (건국자전):
  MAX(국4+수3+영1+탐1, 국3+수4+영1+탐1)
```

---

### 【코드 36~43】 특수 계산 (각 1~2개 학교)

```
코드 36 (대진): 국수영 1위×6 + MAX(2위, 탐구, 한국사)×4
코드 37 (세명간호): 국수탐 상위2 + MAX(영어, 한국사)
코드 38 (신한통합1): 국수 최고 + MAX(영어, 탐구, 한국사)
코드 39 (삼육인문): 국수영탐한 (1위×4 + 2위×3 + 3위×2 + 4위×1)
코드 40 (한림): MAX(국어, 영어)×4 + MAX(MIN(국어,영어), 탐구)×3
코드 41 (삼육자연): 국수영탐한 (1위×4 + 2위×3 + 3위×2 + 4위×1)
코드 42 (신한통합2): 국수영탐한 (1위×5 + 2위×3 + 3위×2)
코드 43 (목원통합): 전과목 (1위×6 + 2위×4)
```

---

### 【코드 44~47】 고려대 세종 (4개 학교)

백분위 기반 변환점수 사용 (고려세변환점수.ts 참조)

```
코드 44 (고려세빅데사): 국0.2 + 수0.35 + 영0.2 + 탐0.25
코드 45 (고려세기계): 국0.2 + 수0.35 + 영0.2 + 탐0.25
코드 46 (고려세경통): 국0.3 + 수0.3 + 영0.2 + 탐0.2
코드 47 (고려세문화): 국0.35 + 수0.2 + 영0.2 + 탐0.25
```

---

### 【코드 48】 경기대 자전 (1개 학교)

백분위 기반 (경기자전변환점수.ts 참조)

```
MAX(
  국0.3 + 수0.35 + 영0.2 + 탐0.15,
  국0.35 + 수0.3 + 영0.2 + 탐0.15
) - 한국사감점
```

---

### 【코드 49~69】 기본형 + 추가가감 (22개 학교)

기본 계산은 코드 1과 동일 + 과탐/미적기하 선택 시 가산점

```
코드 49 (시립세무 등): 탐구2개 시 탐구×0.03 가산
코드 50 (삼육약학): 과탐2개 시 탐구×0.03 가산
코드 51 (세명한의): 과탐2개 시 탐구×0.05 가산
코드 52 (제주): 과탐2개 시 탐구×0.1 가산
코드 53 (영남자연): 과탐2개 시 탐구백분위합×0.1 가산
코드 54, 55: 과탐2개 시 탐구×0.05 가산
코드 56 (시립공학): 과탐2개 시 탐구×0.07 가산
코드 57 (서울자연): 과탐2개 시 Ⅱ과목 여부에 따라 3~5점 가산
코드 58 (관동의학): 탐구2개 + 화학Ⅱ/생명Ⅱ 시 탐구×0.07, 아니면 ×0.05
코드 59 (군산간호): 과탐2개 시 백분위×0.1, 과탐1개 시 ×0.05
코드 60 (청주항운): 과탐2개 + 미적 시 수학환산 가산
코드 61 (서강자연): 과탐Ⅱ 포함 시 (탐구+0.5)×0.6 적용
코드 62 (경남통합): 미적기하 시 수학백분위×0.1 가산
코드 63 (성신생명, 성신정보): 과탐 최고점×0.1 가산
코드 64~67 (교원 물/생/지/화교): 해당 과목 Ⅰ+Ⅱ 시 백분위합×0.05 가산
코드 68 (충북): 미계산
코드 69 (경상): 탐구2개 + 과탐Ⅱ 시 탐구×0.05 가산
```

---

### 【코드 481】 이화여대 간호 (1개 학교)

백분위 기반 (이화간호변환점수.ts 참조)

```
MAX(
  인문형: 국0.3 + 수0.3 + 영0.2 + 탐0.2 + 한국사(인문)
  자연형: 국0.25 + 수0.3 + 영0.2 + 탐0.25×1.06 + 한국사(자연)
)
```

---

## 7. 특수 변환점수 함수

### 7.1 고려세변환점수 (고려세변환점수.ts)

```typescript
// 사탐 백분위 → 변환점수
export const 고려세사탐변환점수: Record<number, number> = {
  100: 70, 99: 69.3, 98: 68.6, ...
};

// 과탐 백분위 → 변환점수
export const 고려세과탐변환점수: Record<number, number> = {
  100: 70, 99: 69.65, 98: 69.3, ...
};

// 영어 등급 → 변환점수
export const 고려세영어변환점수 = [100, 95, 87.5, 75, 60, 40, 25, 12.5, 5];
```

### 7.2 경기자전변환점수 (경기자전변환점수.ts)

```typescript
// 영어 등급 → 변환점수
export const 경기자전영어변환점수 = [100, 96, 89, 77, 60, 40, 23, 11, 4];

// 한국사 등급 → 감점
export const 경기자전한국사변환점수 = [0, 0, 0, 0.4, 0.8, 1.2, 1.6, 2, 2.4];
```

### 7.3 이화간호변환점수 (이화간호변환점수.ts)

```typescript
// 영어 등급 → 변환점수
export const 이화간호영어변환점수 = [100, 98, 94, 88, 80, 70, 58, 44, 28];

// 한국사 등급 → 가산점 (인문)
export const 이화간호한국사인문변환점수 = [10, 10, 10, 9.8, 9.6, 9.4, 9.2, 9, 8.8];

// 한국사 등급 → 가산점 (자연)
export const 이화간호한국사자연변환점수 = [10, 10, 10, 10, 10, 9.8, 9.6, 9.4, 9.2];
```

---

## 8. 데이터 업데이트 시 주의사항

### 8.1 학교코드 일관성

- 점수표, 학교조건, 유불리 세 파일의 학교코드가 **정확히 일치**해야 함
- 학교코드 형식: 한글 (예: `가천의학`, `연세자연`, `서울통합`)

### 8.2 새 환산식코드 추가 시

1. `jungsi-calculation.service.ts`의 `수능환산필수계산기`, `수능환산선택계산기`, `수능환산가중택계산기`, `추가가감계산기`에 case 추가
2. 특수 계산이 필요하면 별도 함수 작성

### 8.3 파일 위치

```
src/modules/jungsi/calculation/
├── data/
│   ├── 점수표-*.json
│   ├── *조건-*.json
│   └── *유불리.json
├── calculations/
│   ├── 고려세변환점수.ts
│   ├── 경기자전변환점수.ts
│   └── 이화간호변환점수.ts
└── services/
    ├── jungsi-data.service.ts      # JSON 로드
    └── jungsi-calculation.service.ts  # 계산 로직
```

---

## 9. 테스트 방법

### 9.1 단일 학교 테스트

```bash
# API 호출 (로그인 필요)
curl -X POST http://localhost:4001/jungsi/calculate \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "mockExamScores": [
      {"subjectCategory": "kor", "subjectName": "국어", "standardScore": "130", "grade": 2, "percentile": 95},
      {"subjectCategory": "math", "subjectName": "미적분", "standardScore": "135", "grade": 1, "percentile": 98},
      {"subjectCategory": "eng", "subjectName": "영어", "standardScore": "", "grade": 1, "percentile": 100},
      {"subjectCategory": "history", "subjectName": "한국사", "standardScore": "", "grade": 2, "percentile": 0},
      {"subjectCategory": "science", "subjectName": "물리학 Ⅰ", "standardScore": "67", "grade": 2, "percentile": 90},
      {"subjectCategory": "science", "subjectName": "화학 Ⅱ", "standardScore": "68", "grade": 2, "percentile": 88}
    ]
  }'
```

### 9.2 저장된 점수 확인

```sql
SELECT university_name, score_calculation,
       ROUND(converted_score::numeric, 2) as 환산점수,
       ROUND(optimal_score::numeric, 2) as 동점수평균,
       ROUND(score_difference::numeric, 2) as 유불리
FROM ts_member_calculated_scores
WHERE score_calculation = '연세자연';
```
